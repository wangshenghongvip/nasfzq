<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel=stylesheet href=lib/bootstrap-4.0.0-dist/css/bootstrap.min.css>
    <link rel=stylesheet href=lib/prismjs-1.13.0/prism.css>
    <link rel=stylesheet href=css/base.css>
    <link rel=stylesheet href=css/ui-block.css>
    <link rel=stylesheet href=css/codemirror.css>
    <style>
        .badge{
            font-size: 18px;
            margin: 5px;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <nav class="navbar navbar-expand-lg navbar-light bg-light static-top navbar-dark bg-dark">

                <button class="navbar-toggler" type="button" data-toggle="collapse"
                        data-target="#bs-example-navbar-collapse-1">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <a class="navbar-brand" href="#">Brand</a>
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="navbar-nav">
                        <li class="nav-item active">
                            <a class="nav-link" href="#">Link <span class="sr-only">(current)</span></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Link</a>
                        </li>
                    </ul>

                </div>
            </nav>
        </div>
    </div>
</div>
<div class="container-fluid">

    <div class="jumbotron text-center">
        <h1>区块链份子钱记账本</h1>
        <p>说明:请使用帐号（钱包地址）登录查看记账</p>
        <p>
            <button class="btn btn-primary btn-lg start" role="button">开始使用</button>
        </p>
    </div>
    <div class="deploy_contract tab" id=tab3>
        <div class=select-wallet-file></div>

        <div class="form-group row">
            <div class=col>
                <label data-i18n=send-nas/from-address></label>
                <div class=icon-address data-id=run_from_addr data-disabled></div>
            </div>
            <div class=col>
                <label data-i18n=send-nas/to-address></label>
                <div class=icon-address data-id=run_to_addr></div>
            </div>
        </div>

        <div class="form-group row">
            <div class=col>
                <label data-i18n=send-nas/balance></label>
                <input class=form-control disabled id=run_balance>
            </div>
            <div class=col>
                <label data-i18n=send-nas/amount></label>
                <input class=form-control id=run_value value=0 data-validate-order-matters="required number">
            </div>
        </div>

        <div class="form-group row">
            <div class=col>
                <label data-i18n=gas-limit></label>
                <input class=form-control type=text id=run_gas_limit value=200000>
            </div>
            <div class=col>
                <label data-i18n=gas-price></label>
                <i>( 1 NAS = 1EWei = 10
                    <sup>18</sup> Wei )</i>
                <input class=form-control type=text id=run_gas_price>
            </div>
        </div>

        <div class="active1 result" id=result></div>

        <div class="form-group row">
            <div class=col>
                <button class="btn btn-block" data-i18n=contract/call_submit disabled id=call></button>
            </div>
        </div>
    </div>
    <a id="modal-565270" href="#modal-container-565270" role="button" class="btn" data-toggle="modal">记账</a>
    <div class="card">
        <div class="card-header">
            <a class="card-link collapsed" data-toggle="collapse"  href="#card-element-932591"><span class="badge badge-dark">张三</span>  <span class="badge badge-success">金额:1000元</span> <span class="badge badge-info align-content-end">收入</span></a></a></a>
            <button class="btn btn-sm btn-light float-lg-right">删除 </button>
        </div>
        <div id="card-element-932591" class="collapse ">
            <div class="card-body">
                <span class="badge badge-info">类别:结婚</span></a>
                <span class="badge badge-primary">时间:2008</span></a>
                <span class="badge badge-secondary">备注:非常好请使用帐号（钱包地址）（钱包地址）登录查看记请使用帐号（钱包地址）登录查看记请使用帐号（钱包地址）登录查看记</span>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modal-container-565270" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="myModalLabel">
                        记帐
                    </h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="col-lg-12">
                        <form>
                            <div class="form-group row">
                                <label class="col-lg-2 col-form-label">姓名</label>
                                <div class="col-lg-10">

                                    <input type="text" class="form-control" id="u_name" placeholder="请输入记帐人姓名">
                                </div>
                            </div>
                            <div class="form-group row ">
                                <label class="col-lg-2 col-form-label">金额</label>
                                <div class="col-lg-10">
                                    <input class="form-control " type="text" id="u_money" placeholder="请输入金额">
                                </div>
                            </div>

                            <div class="form-group row">
                                <label class="col-lg-2 col-form-label">类别</label>
                                <div class="col-lg-10 input-group">
                                    <input type="text" class="form-control " id="u_cause"
                                           placeholder="请输入或选择类别">
                                    <div class="input-group-button ">
                                        <button class="btn dropdown-toggle" type="button"
                                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item  a_cause" href="#">结婚</a>
                                            <a class="dropdown-item  a_cause" href="#" >生孩子</a>
                                            <a class="dropdown-item  a_cause" href="#">开业</a>
                                            <a class="dropdown-item  a_cause" href="#">乔迁</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group row ">
                                <label class="col-lg-2 col-form-label">日期</label>
                                <div class="col-lg-10" >
                                    <input class="form-control "  id="u_date" type="text" placeholder="请输入日期">
                                </div>
                            </div>
                            <div class="form-group row ">
                                <label class="col-lg-2 col-form-label">备注</label>
                                <div class="col-lg-10" >
                                    <input class="form-control " id="u_mark" type="text" placeholder="请输入备注">
                                </div>
                            </div>
                            <div class="form-group text-center row">
                                <div class="radio " style="margin-left: 20px">
                                    <label>
                                        <input type="radio" name="optionsRadios" id="optionsRadios1" value="收入" checked>
                                        收入
                                    </label>
                                </div>
                                <div class="radio" style="margin-left: 10px">
                                    <label>
                                        <input type="radio" name="optionsRadios" id="optionsRadios2" value="支出">
                                        支出
                                    </label>
                                </div>
                            </div>

                        </form>
                    </div>
                </div>
                <div class="modal-footer">

                    <button type="button" class="btn btn-primary" id="save_u">
                        保存
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        取消
                    </button>
                </div>
            </div>

        </div>

    </div>

    <!-- 选择钱包 -->
    <!--<div class="container select-wallet-file"></div>-->

</div>
<div class="fade loading modal" data-backdrop=static>
    <div class=modal-dialog>
        <div class=modal-content>
            <div class=modal-body>
                <div class=progress>
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role=progressbar
                         style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--<script src="./js/jquery-3.3.1.min.js"></script>-->
<!--<script src="./js/bootstrap.min.js"></script>-->


<!--<script src="./js/angular.min.js"/>-->
<!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
<!--<script src="https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>-->
<!--&lt;!&ndash; 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 &ndash;&gt;-->
<!--<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>-->
<script src=lib/jquery-3.3.1.min.js></script>
<script src=lib/bootstrap-4.0.0-dist/js/bootstrap.bundle.min.js data-depends=jquery.slim></script>
<script src=lib/bootbox.min.js data-depends="bootstrap jquery.slim"></script>
<script src=lib/blockies.min.js></script>
<script src=lib/js-beautify-1.7.5/beautify.js></script>
<script src=lib/prismjs-1.13.0/prism.js></script>
<script src=lib/nebulas.js></script>
<script src=js/1-localSave.js></script>
<script src=js/home.v1.js></script>
<script src=js/i18n.js data-depends=jquery.slim></script>
<script src=js/ui-block.js data-depends="bootbox blockies jquery.slim i18n.js nebulas.js"></script>
<script src=lib/codemirror/codemirror.js></script>
<script src=lib/codemirror/javascript.js></script>
<script>
    $(".start").click(function () {
        alert("xxhong")
    })
    $('#save_u').click(function () {
        var uname = $('#u_name').val();
        var umoney = $('#u_money').val();
        if(!uname){
            bootbox.dialog({
                backdrop: true,
                onEscape: true,
                message: localSave.getItem("lang") == "en" ? e : "姓名不能为空",
                size: "large",
                title: "提示"
            });
            return
        }
        if(!umoney){
            bootbox.dialog({
                backdrop: true,
                onEscape: true,
                message: localSave.getItem("lang") == "en" ? e : "金额不能为空",
                size: "large",
                title: "提示"
            });
            return;
        }

        var ucause = $('#u_cause').val();
        var udate = $('#u_date').val();
        var umark = $('#u_mark').val();
        var utype = $("input[name='optionsRadios']:checked").val();
        console.log("uname："+uname+ " umoney:"+umoney+" ucause:"+ucause+" udate:"+udate+" umark:"+umark+" utype:"+utype)
        $(".modal").modal("hide");//关闭模态框
    });
    $('.modal').click(function(){//设置事件
        $('#u_cause').val($(this).text());
    })
    var nebulas = require("nebulas"),
        Account = nebulas.Account,
        Utils = nebulas.Utils,
        neb = new nebulas.Neb(),
        globalParams = {
            account: null
        },
        validateTab3 = uiBlock.validate("#tab3");

    neb.setRequest(new nebulas.HttpRequest(localSave.getItem("apiPrefix") || "https://testnet.nebulas.io/"));
    uiBlock.insert({
        footer: ".footer",
        header: ".header",
        iconAddress: ".icon-address",//来自地址、目的地址
        logoMain: ".logo-main",
        numberComma: ".number-comma",
        selectWalletFile: [".select-wallet-file", onUnlockFile]
    });

    $("#call").on("click", onClickCall);

    /**
     * unlock执行的方法
     * @param swf
     * @param fileJson
     * @param account
     * @param password
     */
    function onUnlockFile(swf, fileJson, account, password) {
        var balance_nas, state,
            fromAddr = account.getAddressString(),
            $tab = $(swf).closest(".tab");

        $(".modal.loading").modal("show");

        $("#run_from_addr").val(fromAddr).trigger("input");
//        if ($tab.prop("id") == "tab2") {
//            $("#from_addr").val(fromAddr).trigger("input");
//            $("#to_addr").val(account.getAddressString()).trigger("input");
//        } else if ($tab.prop("id") == "tab3")
//            $("#run_from_addr").val(fromAddr).trigger("input");

        try {
            account.fromKey(fileJson, password);
            globalParams.account = account;
            $("#unlock").hide();
            $("#send").show();

            neb.api.gasPrice()
                .then(function (resp) {
                    $("#gas_price").val(resp.gas_price);
                    $("#run_gas_price").val(resp.gas_price);

                    return neb.api.getAccountState(fromAddr);
                })
                .then(function (resp) {
                    //submit 要处理
                    $("#call").attr("disabled", false);
//                        $("#call_result").text("");
//                        $(".next").removeClass("active1");
                    var balance = nebulas.Unit.fromBasic(resp.balance, "nas");

                    $("#run_balance").val(balance + " NAS");

                    $(".modal.loading").modal("hide");
                })
                .catch(function (e) {
                    // this catches e thrown by nebulas.js!neb

                    bootbox.dialog({
                        backdrop: true,
                        onEscape: true,
                        message: i18n.apiErrorToText(e.message),
                        size: "large",
                        title: "Error"
                    });

                    $(".modal.loading").modal("hide");
                });
        } catch (e) {
            // this catches e thrown by nebulas.js!account
            bootbox.dialog({
                backdrop: true,
                onEscape: true,
                message: localSave.getItem("lang") == "en" ? e : "keystore 文件错误, 或者密码错误",
                size: "large",
                title: "Error"
            });

            $(".modal.loading").modal("hide");
        }
    }

    /**
     * 提交
     */
    function onClickCall() {
        $(".modal.loading").modal("show");

        innerCall(function (params) {
            var gTx = new nebulas.Transaction(parseInt(localSave.getItem("chainId")),
                globalParams.account,
                params.to, params.value, params.nonce, params.gasPrice, params.gasLimit, params.contract);

            gTx.signTransaction();
            neb.api
                .sendRawTransaction(gTx.toProtoString())
                .then(function (resp) {
                    console.log(JSON.stringify(resp));
                    $("#call_result").text(JSON.stringify(resp));
                    $(".result").removeClass("active1");
                    $(".next").removeClass("active1");
                    $("#receipt_call").text(resp.txhash).prop("href", "check.html?" + resp.txhash);
                    $(".modal.loading").modal("hide");
                })
                .catch(function (err) {
                    $("#call_result").text(JSON.stringify(err));
                    $(".result").removeClass("active1");
                    $(".next").removeClass("active1");
                    $(".modal.loading").modal("hide");
                });
        });
    }

    function innerCall(callback) {
        let params = {};

        if (!globalParams.account) {
            // TODO 提示钱包信息不正确
            return;
        }
        params.from = globalParams.account.getAddressString();

        // prepare to
        let toAddr = $("#run_to_addr").val().trim();
        if (!Account.isValidAddress(toAddr)) {
            $("#run_to_addr").addClass("err");
            setTimeout(function () {
                $("#run_to_addr").removeClass("err");
            }, 5000);
            return;
        }
        params.to = toAddr;

        // prepare gasLimit
        let gasLimit = Utils.toBigNumber(0);
        try {
            gasLimit = Utils.toBigNumber($("#run_gas_limit").val());
        } catch (err) {
            console.log(err);
        }
        if (gasLimit.cmp(Utils.toBigNumber(0)) <= 0) {
            $("#run_gas_limit").addClass("err");
            setTimeout(function () {
                $("#run_gas_limit").removeClass("err");
            }, 5000);
            return;
        }
        params.gasLimit = gasLimit.toNumber();

        // prepare gasPrice
        let gasPrice = Utils.toBigNumber(0);
        try {
            gasPrice = Utils.toBigNumber($("#run_gas_price").val());
        } catch (err) {
            console.log(err);
        }
        if (gasPrice.cmp(Utils.toBigNumber(0)) <= 0) {
            $("#run_gas_price").addClass("err");
            setTimeout(function () {
                $("#run_gas_price").removeClass("err");
            }, 5000);
            return;
        }
        params.gasPrice = gasPrice.toNumber();

        // prepare value
        let value = Utils.toBigNumber(0);
        try {
            value = nebulas.Unit.toBasic(Utils.toBigNumber($("#run_value").val()), "nas");
        } catch (err) {
            console.log(err);
        }
        if (value.cmp(Utils.toBigNumber(0)) < 0) {
            // TODO 添加提示value输入不对
            console.log("invalid value");
            return;
        }
        params.value = value;

        // prepare contract
        params.contract = {
            "function": 'get',
//            "args": $("#call_args").val().trim()//取方法参数
        };

        // prepare nonce
        // needs refresh data on every 'test' and 'commit' call, because data update may slow,
        // you can get different result by hit 'test' multiple times
        neb.api.getAccountState(params.from).then(function (resp) {
            var balance = nebulas.Unit.fromBasic(resp.balance, "nas"),
                $tab = $(".show.tab");

            params.nonce = parseInt(resp.nonce) + 1;

            $("#run_balance").val(balance + " NAS");

            callback(params);
        }).catch(function (err) {
            // console.log("prepare nonce error: " + err);
            bootbox.dialog({
                backdrop: true,
                onEscape: true,
                message: i18n.apiErrorToText(err.message),
                size: "large",
                title: "Error"
            });
        });
    }
</script>
</body>
</html>

















